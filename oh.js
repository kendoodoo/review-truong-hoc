/**Hermiteresize-fastimageresize/resampleusingHermitefilter.*https://github.com/viliusle/Hermite-resize*/functionHermite_class(){varcores;varworkers_archive=[];varworkerBlobURL;/***contructor*/this.init=function(){cores=navigator.hardwareConcurrency||4;}();/***ReturnsCPUcorescount**@returns{int}*/this.getCores=function(){returncores;};/***Hermiteresize.Detectcpucountandusebestoptionforuser.**@param{HtmlElement}canvas*@param{int}width*@param{int}height*@param{boolean}resize_canvasiftrue,canvaswillberesized.Optional.*@param{boolean}on_finishfinishhandler.Optional.*/this.resample_auto=function(canvas,width,height,resize_canvas,on_finish){varcores=this.getCores();if(!!window.Worker&&cores>1){//workerssupportedandwehaveatleast2cpucores-usingmultithreadingthis.resample(canvas,width,height,resize_canvas,on_finish);}else{//1cpuversionthis.resample_single(canvas,width,height,true);if(on_finish!=undefined){on_finish();}}};/***Hermiteresize.Resizeactualimage.**@param{string}image_id*@param{int}width*@param{int}heightoptional.*@param{int}percentagesoptional.*@param{string}multi_coreoptional.*/this.resize_image=function(image_id,width,height,percentages,multi_core){varimg=document.getElementById(image_id);//createtempcanvasvartemp_canvas=document.createElement("canvas");temp_canvas.width=img.width;temp_canvas.height=img.height;vartemp_ctx=temp_canvas.getContext("2d");//drawimagetemp_ctx.drawImage(img,0,0);//preparesizeif(width==undefined&&height==undefined&&percentages!=undefined){width=img.width/100*percentages;height=img.height/100*percentages;}if(height==undefined){varratio=img.width/width;height=img.height/ratio;}width=Math.round(width);height=Math.round(height);varon_finish=function(){vardataURL=temp_canvas.toDataURL();img.width=width;img.height=height;img.src=dataURL;dataURL=null;temp_canvas=null;};//resizeif(multi_core==undefined||multi_core==true){this.resample(temp_canvas,width,height,true,on_finish);}else{this.resample_single(temp_canvas,width,height,true);on_finish();}};/***Hermiteresize,multicoreversion-fastimageresize/resampleusingHermitefilter.**@param{HtmlElement}canvas*@param{int}width*@param{int}height*@param{boolean}resize_canvasiftrue,canvaswillberesized.Optional.*@param{boolean}on_finishfinishhandler.Optional.*/this.resample=function(canvas,width,height,resize_canvas,on_finish){varwidth_source=canvas.width;varheight_source=canvas.height;width=Math.round(width);height=Math.round(height);varratio_h=height_source/height;//stopoldworkersif(workers_archive.length>0){for(varc=0;c<cores;c++){if(workers_archive[c]!=undefined){workers_archive[c].terminate();deleteworkers_archive[c];}}}workers_archive=newArray(cores);varctx=canvas.getContext("2d");//preparesourceandtargetdataforworkersvardata_part=[];varblock_height=Math.ceil(height_source/cores/2)*2;varend_y=-1;for(varc=0;c<cores;c++){//sourcevaroffset_y=end_y+1;if(offset_y>=height_source){//sizetoosmall,nothingleftforthiscorecontinue;}end_y=offset_y+block_height-1;end_y=Math.min(end_y,height_source-1);varcurrent_block_height=block_height;current_block_height=Math.min(block_height,height_source-offset_y);//console.log('sourcesplit:','#'+c,offset_y,end_y,'height:'+current_block_height);data_part[c]={};data_part[c].source=ctx.getImageData(0,offset_y,width_source,block_height);data_part[c].target=true;data_part[c].start_y=Math.ceil(offset_y/ratio_h);data_part[c].height=current_block_height;}//clearandresizecanvasif(resize_canvas===true){canvas.width=width;canvas.height=height;}else{ctx.clearRect(0,0,width_source,height_source);}//startvarworkers_in_use=0;for(varc=0;c<cores;c++){if(data_part[c]==undefined){//nojobforthisworkercontinue;}workers_in_use++;varmy_worker=newWorker(workerBlobURL);workers_archive[c]=my_worker;my_worker.onmessage=function(event){workers_in_use--;varcore=event.data.core;workers_archive[core].terminate();deleteworkers_archive[core];//drawvarheight_part=Math.ceil(data_part[core].height/ratio_h);data_part[core].target=ctx.createImageData(width,height_part);data_part[core].target.data.set(event.data.target);ctx.putImageData(data_part[core].target,0,data_part[core].start_y);if(workers_in_use<=0){//finishif(on_finish!=undefined){on_finish();}}};varobjData={width_source:width_source,height_source:data_part[c].height,width:width,height:Math.ceil(data_part[c].height/ratio_h),core:c,source:data_part[c].source.data.buffer,};my_worker.postMessage(objData,[objData.source]);}};//Buildaworkerfromananonymousfunctionbody-purposeistoavoidseparatefileworkerBlobURL=window.URL.createObjectURL(newBlob(['(',function(){//beginworkeronmessage=function(event){varcore=event.data.core;varwidth_source=event.data.width_source;varheight_source=event.data.height_source;varwidth=event.data.width;varheight=event.data.height;varratio_w=width_source/width;varratio_h=height_source/height;varratio_w_half=Math.ceil(ratio_w/2);varratio_h_half=Math.ceil(ratio_h/2);varsource=newUint8ClampedArray(event.data.source);varsource_h=source.length/width_source/4;vartarget_size=width*height*4;vartarget_memory=newArrayBuffer(target_size);vartarget=newUint8ClampedArray(target_memory,0,target_size);//calculatefor(varj=0;j<height;j++){for(vari=0;i<width;i++){varx2=(i+j*width)*4;varweight=0;varweights=0;varweights_alpha=0;vargx_r=0;vargx_g=0;vargx_b=0;vargx_a=0;varcenter_y=j*ratio_h;varxx_start=Math.floor(i*ratio_w);varxx_stop=Math.ceil((i+1)*ratio_w);varyy_start=Math.floor(j*ratio_h);varyy_stop=Math.ceil((j+1)*ratio_h);xx_stop=Math.min(xx_stop,width_source);yy_stop=Math.min(yy_stop,height_source);for(varyy=yy_start;yy<yy_stop;yy++){vardy=Math.abs(center_y-yy)/ratio_h_half;varcenter_x=i*ratio_w;varw0=dy*dy;//pre-calcpartofwfor(varxx=xx_start;xx<xx_stop;xx++){vardx=Math.abs(center_x-xx)/ratio_w_half;varw=Math.sqrt(w0+dx*dx);if(w>=1){//pixeltoofarcontinue;}//hermitefilterweight=2*w*w*w-3*w*w+1;//calcsourcepixellocationvarpos_x=4*(xx+yy*width_source);//alphagx_a+=weight*source[pos_x+3];weights_alpha+=weight;//colorsif(source[pos_x+3]<255)weight=weight*source[pos_x+3]/250;gx_r+=weight*source[pos_x];gx_g+=weight*source[pos_x+1];gx_b+=weight*source[pos_x+2];weights+=weight;}}target[x2]=gx_r/weights;target[x2+1]=gx_g/weights;target[x2+2]=gx_b/weights;target[x2+3]=gx_a/weights_alpha;}}//returnvarobjData={core:core,target:target,};postMessage(objData,[target.buffer]);};//endworker}.toString(),')()'],{type:'application/javascript'}));/***Hermiteresize-fastimageresize/resampleusingHermitefilter.1cpuversion!**@param{HtmlElement}canvas*@param{int}width*@param{int}height*@param{boolean}resize_canvasiftrue,canvaswillberesized.Optional.*/this.resample_single=function(canvas,width,height,resize_canvas){varwidth_source=canvas.width;varheight_source=canvas.height;width=Math.round(width);height=Math.round(height);varratio_w=width_source/width;varratio_h=height_source/height;varratio_w_half=Math.ceil(ratio_w/2);varratio_h_half=Math.ceil(ratio_h/2);varctx=canvas.getContext("2d");varimg=ctx.getImageData(0,0,width_source,height_source);varimg2=ctx.createImageData(width,height);vardata=img.data;vardata2=img2.data;for(varj=0;j<height;j++){for(vari=0;i<width;i++){varx2=(i+j*width)*4;varweight=0;varweights=0;varweights_alpha=0;vargx_r=0;vargx_g=0;vargx_b=0;vargx_a=0;varcenter_y=j*ratio_h;varxx_start=Math.floor(i*ratio_w);varxx_stop=Math.ceil((i+1)*ratio_w);varyy_start=Math.floor(j*ratio_h);varyy_stop=Math.ceil((j+1)*ratio_h);xx_stop=Math.min(xx_stop,width_source);yy_stop=Math.min(yy_stop,height_source);for(varyy=yy_start;yy<yy_stop;yy++){vardy=Math.abs(center_y-yy)/ratio_h_half;varcenter_x=i*ratio_w;varw0=dy*dy;//pre-calcpartofwfor(varxx=xx_start;xx<xx_stop;xx++){vardx=Math.abs(center_x-xx)/ratio_w_half;varw=Math.sqrt(w0+dx*dx);if(w>=1){//pixeltoofarcontinue;}//hermitefilterweight=2*w*w*w-3*w*w+1;varpos_x=4*(xx+yy*width_source);//alphagx_a+=weight*data[pos_x+3];weights_alpha+=weight;//colorsif(data[pos_x+3]<255)weight=weight*data[pos_x+3]/250;gx_r+=weight*data[pos_x];gx_g+=weight*data[pos_x+1];gx_b+=weight*data[pos_x+2];weights+=weight;}}data2[x2]=gx_r/weights;data2[x2+1]=gx_g/weights;data2[x2+2]=gx_b/weights;data2[x2+3]=gx_a/weights_alpha;}}//clearandresizecanvasif(resize_canvas===true){canvas.width=width;canvas.height=height;}else{ctx.clearRect(0,0,width_source,height_source);}//drawctx.putImageData(img2,0,0);};}
